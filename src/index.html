<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oxidian</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <div id="main-layout">
            <!-- Ribbon (narrow icon strip, far left) -->
            <nav id="ribbon">
                <div class="ribbon-top">
                    <button class="ribbon-btn active" data-panel="explorer" title="File Explorer">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                    </button>
                    <button class="ribbon-btn" data-panel="search" title="Search">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    </button>
                    <button class="ribbon-btn" data-panel="bookmarks" title="Bookmarks">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
                    </button>
                    <button class="ribbon-btn" data-panel="outline" title="Outline">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/><circle cx="3" cy="12" r="1" fill="currentColor"/><circle cx="3" cy="18" r="1" fill="currentColor"/></svg>
                    </button>
                    <button class="ribbon-btn" data-panel="recent" title="Recent Files">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </button>
                    <button class="ribbon-btn" data-action="graph" title="Graph View">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/><circle cx="18" cy="6" r="3"/><path d="M8.5 7.5L15.5 16.5M15.5 7.5L8.5 16.5"/></svg>
                    </button>
                </div>
                <div class="ribbon-bottom">
                    <button class="ribbon-btn" data-action="daily" title="Daily Note">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    </button>
                    <button class="ribbon-btn" data-action="focus" title="Focus Mode (Ctrl+Shift+D)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>
                    </button>
                    <button class="ribbon-btn" data-action="settings" title="Settings">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                    </button>
                </div>
            </nav>

            <!-- Sidebar Panel -->
            <aside id="sidebar">
                <div id="panel-explorer" class="sidebar-panel active">
                    <div class="sidebar-panel-header">
                        <span class="panel-title">EXPLORER</span>
                        <div class="sidebar-actions">
                            <button class="icon-btn" id="btn-new-note" title="New Note">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                            </button>
                            <button class="icon-btn" id="btn-new-folder" title="New Folder">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                            </button>
                            <button class="icon-btn" id="btn-refresh" title="Refresh">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="file-tree"></div>
                    <div id="tags-section">
                        <div class="sidebar-panel-header">
                            <span class="panel-title">TAGS</span>
                        </div>
                        <div id="tags-list"></div>
                    </div>
                </div>

                <div id="panel-search" class="sidebar-panel">
                    <div class="sidebar-panel-header">
                        <span class="panel-title">SEARCH</span>
                    </div>
                    <div class="search-input-wrap">
                        <input type="text" id="search-input" placeholder="Search notes..." autocomplete="off">
                    </div>
                    <div id="search-results"></div>
                </div>

                <div id="panel-bookmarks" class="sidebar-panel">
                    <div class="sidebar-panel-header">
                        <span class="panel-title">BOOKMARKS</span>
                        <div class="sidebar-actions">
                            <button class="icon-btn" id="btn-bookmark-current" title="Bookmark current note">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="bookmarks-list" class="empty-panel-message">No bookmarks yet</div>
                </div>

                <div id="panel-outline" class="sidebar-panel">
                    <div class="sidebar-panel-header">
                        <span class="panel-title">OUTLINE</span>
                    </div>
                    <div id="outline-list" class="empty-panel-message">Open a note to see its outline</div>
                </div>

                <div id="panel-recent" class="sidebar-panel">
                    <div class="sidebar-panel-header">
                        <span class="panel-title">RECENT FILES</span>
                        <div class="sidebar-actions">
                            <button class="icon-btn" id="btn-clear-recent" title="Clear recent files">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="recent-list" class="empty-panel-message">No recent files</div>
                </div>
            </aside>

            <!-- Sidebar Resize Handle -->
            <div id="sidebar-resize" class="resize-handle"></div>

            <!-- Main Content Area -->
            <div id="content-area">
                <div id="tab-bar">
                    <div id="tab-list"></div>
                </div>
                <div id="breadcrumb-bar">
                    <div id="breadcrumb-path"></div>
                </div>
                <div id="pane-container"></div>

                <!-- Welcome Screen -->
                <div id="welcome-screen">
                    <div class="welcome-content">
                        <h1>‚óà Oxidian</h1>
                        <p>Your open-source note-taking companion</p>
                        <div class="welcome-actions">
                            <button id="btn-welcome-daily" class="welcome-btn primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                Open Today's Daily Note
                            </button>
                            <button id="btn-welcome-new" class="welcome-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                                Create New Note
                            </button>
                        </div>
                        <div class="welcome-shortcuts">
                            <h3>Keyboard Shortcuts</h3>
                            <div class="shortcut"><kbd>Ctrl+N</kbd> New Note</div>
                            <div class="shortcut"><kbd>Ctrl+S</kbd> Save</div>
                            <div class="shortcut"><kbd>Ctrl+Shift+F</kbd> Search</div>
                            <div class="shortcut"><kbd>Ctrl+D</kbd> Daily Note</div>
                            <div class="shortcut"><kbd>Ctrl+P</kbd> Command Palette</div>
                            <div class="shortcut"><kbd>Ctrl+E</kbd> Toggle Preview</div>
                            <div class="shortcut"><kbd>Ctrl+,</kbd> Settings</div>
                            <div class="shortcut"><kbd>Ctrl+Shift+D</kbd> Focus Mode</div>
                            <div class="shortcut"><kbd>/</kbd> Slash Commands</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <footer id="statusbar">
            <div class="status-left">
                <span id="status-backlinks">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                    <span id="backlink-count">0 backlinks</span>
                </span>
            </div>
            <div class="status-right">
                <span id="status-reading-time">1 min read</span>
                <span id="status-word-count">0 words</span>
                <span id="status-char-count">0 characters</span>
                <span id="status-cursor">Ln 1, Col 1</span>
            </div>
        </footer>
    </div>

    <!-- New Note Dialog -->
    <div id="new-note-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <h3>New Note</h3>
            <input type="text" id="new-note-name" placeholder="Note name..." autocomplete="off">
            <div class="dialog-actions">
                <button id="btn-dialog-cancel" class="btn-secondary">Cancel</button>
                <button id="btn-dialog-create" class="btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- Password Prompt Dialog (for encrypted vaults) -->
    <div id="password-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <h3>üîí Unlock Vault</h3>
            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 14px;">Your vault is encrypted. Enter your password to unlock.</p>
            <input type="password" id="vault-password-input" placeholder="Enter vault password..." autocomplete="off">
            <div id="password-error" style="color: var(--text-red); font-size: 12px; margin-bottom: 8px; display: none;">Incorrect password</div>
            <div class="dialog-actions">
                <button id="btn-unlock-vault" class="btn-primary">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Screen -->
    <div id="onboarding-screen" class="onboarding-overlay hidden"></div>

    <!-- New Folder Dialog -->
    <div id="new-folder-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <h3>üìÅ New Folder</h3>
            <input type="text" id="new-folder-name" placeholder="Folder name..." autocomplete="off">
            <div class="dialog-actions">
                <button id="btn-folder-cancel" class="btn-secondary">Cancel</button>
                <button id="btn-folder-create" class="btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu hidden"></div>

    <!-- Settings Dialog (legacy, hidden ‚Äî settings now opens as tab) -->
    <div id="settings-dialog" class="dialog-overlay hidden">
        <div class="dialog dialog-lg">
            <h3>Settings</h3>
            <div class="settings-group">
                <label>Editor Font Family</label>
                <input type="text" id="setting-font-family" value="JetBrains Mono, Fira Code, Consolas, monospace">
            </div>
            <div class="settings-group">
                <label>Editor Font Size</label>
                <input type="range" id="setting-font-size" min="12" max="24" value="15">
                <span id="setting-font-size-val">15px</span>
            </div>
            <div class="dialog-actions">
                <button id="btn-settings-close" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Password unlock handler (before modules load)
        document.addEventListener('DOMContentLoaded', () => {
            const unlockBtn = document.getElementById('btn-unlock-vault');
            const pwdInput = document.getElementById('vault-password-input');
            const pwdError = document.getElementById('password-error');

            const doUnlock = async () => {
                const pwd = pwdInput.value;
                if (!pwd) return;
                try {
                    const ok = await window.__TAURI__.core.invoke('unlock_vault', { password: pwd });
                    if (ok) {
                        document.getElementById('password-dialog').classList.add('hidden');
                        // Refresh sidebar and tags after unlocking so decrypted content is accessible
                        if (window.app) {
                            window.app.sidebar?.refresh();
                            window.app.loadTags?.();
                        }
                    } else {
                        pwdError.style.display = 'block';
                        pwdInput.value = '';
                        pwdInput.focus();
                    }
                } catch (err) {
                    pwdError.textContent = 'Error: ' + err;
                    pwdError.style.display = 'block';
                }
            };

            unlockBtn?.addEventListener('click', doUnlock);
            pwdInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') doUnlock();
            });
        });
    </script>
    <script src="js/obsidian-api.js" type="module"></script>
    <script src="js/plugin-loader.js" type="module"></script>
    <script src="js/app.js" type="module"></script>
</body>
</html>
